
import React, { useState, useEffect, useRef } from 'react';
import { BrowserRouter, useNavigate, useLocation } from 'react-router-dom';
import Layout from './components/Layout';
import AdminPanel from './components/AdminPanel';
import Login from './components/Login';
import ImageGallery from './components/ImageGallery';
import { GameKB, GameCategory, SectionType, KBItem, CustomSectionType, KBSubItem } from './types';
import { INITIAL_GAMES } from './constants';

// è·å–æ‰€æœ‰å¯ç”¨çš„æ¿å—ç±»å‹ï¼ˆä»localStorageï¼‰
const getAllAvailableSectionTypes = (): string[] => {
  const saved = localStorage.getItem('allSectionTypes');
  if (saved) {
    return JSON.parse(saved);
  }
  // é»˜è®¤æ¿å—ç±»å‹
  return [
    SectionType.MECHANICS,
    SectionType.CONTACT,
    SectionType.TERMINOLOGY,
    SectionType.FAQ,
    SectionType.PRACTICE
  ];
};

// ä¿å­˜æ‰€æœ‰æ¿å—ç±»å‹
const saveAllSectionTypes = (types: string[]) => {
  localStorage.setItem('allSectionTypes', JSON.stringify(types));
};

// è·å–æ‰€æœ‰æ¿å—ç±»å‹ï¼ˆåŒ…æ‹¬è‡ªå®šä¹‰çš„ï¼‰- ä¿æŒå‘åå…¼å®¹
const getAllSectionTypes = (): string[] => {
  return getAllAvailableSectionTypes();
};

// è·å–è‡ªå®šä¹‰æ¿å—ç±»å‹åˆ—è¡¨ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
const getCustomSectionTypes = (): CustomSectionType[] => {
  const allTypes = getAllAvailableSectionTypes();
  const defaultTypes = Object.values(SectionType);
  // æ‰¾å‡ºä¸åœ¨é»˜è®¤ç±»å‹ä¸­çš„ï¼Œä½œä¸ºè‡ªå®šä¹‰ç±»å‹
  return allTypes
    .filter(type => !defaultTypes.includes(type as SectionType))
    .map((name, index) => ({ id: `custom-${index}`, name }));
};

// ä¿å­˜è‡ªå®šä¹‰æ¿å—ç±»å‹ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
const saveCustomSectionTypes = (types: CustomSectionType[]) => {
  const allTypes = getAllAvailableSectionTypes();
  const defaultTypes = Object.values(SectionType);
  const customNames = types.map(t => t.name);
  // åˆå¹¶é»˜è®¤ç±»å‹å’Œè‡ªå®šä¹‰ç±»å‹
  const newAllTypes = [...defaultTypes, ...customNames];
  saveAllSectionTypes(newAllTypes);
};

// å•å¼ å›¾ç‰‡æ”¾å¤§ç»„ä»¶
const ImageZoom: React.FC<{ imageUrl: string; alt: string }> = ({ imageUrl, alt }) => {
  const [isZoomed, setIsZoomed] = useState(false);

  const handleImageClick = () => {
    setIsZoomed(true);
  };

  const handleCloseZoom = (e: React.MouseEvent) => {
    if (e.target === e.currentTarget) {
      setIsZoomed(false);
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Escape') {
      setIsZoomed(false);
    }
  };

  return (
    <>
      <div className="my-4 cursor-pointer hover:opacity-90 transition-opacity" onClick={handleImageClick}>
        <div className="relative">
          <img 
            src={imageUrl} 
            alt={alt}
            className="w-full rounded-xl border border-gray-200"
            style={{ maxHeight: '600px', objectFit: 'contain' }}
            onError={(e) => {
              (e.target as HTMLImageElement).style.display = 'none';
            }}
          />
          <div className="absolute top-2 left-2 bg-black/50 text-white px-3 py-1 rounded-full text-xs">
            é»æ“Šæ”¾å¤§
          </div>
        </div>
      </div>

      {/* æ”¾å¤§Modal */}
      {isZoomed && (
        <div
          className="fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4"
          onClick={handleCloseZoom}
          onKeyDown={handleKeyDown}
          tabIndex={0}
        >
          <button
            onClick={handleCloseZoom}
            className="absolute top-4 right-4 bg-white/20 hover:bg-white/30 text-white p-3 rounded-full transition-all text-2xl z-10"
          >
            âœ•
          </button>
          <img
            src={imageUrl}
            alt={alt}
            className="max-w-full max-h-full w-auto h-auto object-contain"
            onClick={(e) => e.stopPropagation()}
            onError={(e) => {
              (e.target as HTMLImageElement).style.display = 'none';
            }}
          />
        </div>
      )}
    </>
  );
};

// Banner é…ç½®å¼¹çª—ç»„ä»¶
const BannerConfigModal: React.FC<{
  game: GameKB;
  onClose: () => void;
  onSave: (bannerTitle: string, bannerLink: string, bannerImage: string) => void;
}> = ({ game, onClose, onSave }) => {
  const [bannerTitle, setBannerTitle] = useState(game.bannerTitle || '');
  const [bannerLink, setBannerLink] = useState(game.bannerLink || '');
  const [bannerImage, setBannerImage] = useState(game.bannerImage || '');
  const fileInputRef = React.useRef<HTMLInputElement>(null);
  const [isUploading, setIsUploading] = useState(false);

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
      alert('è«‹é¸æ“‡åœ–ç‰‡æ–‡ä»¶ï¼');
      return;
    }

    if (file.size > 5 * 1024 * 1024) {
      alert('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 5MBï¼');
      return;
    }

    setIsUploading(true);

    const reader = new FileReader();
    reader.onloadend = () => {
      const base64String = reader.result as string;
      setBannerImage(base64String);
      setIsUploading(false);
      
      if (fileInputRef.current) {
        fileInputRef.current.value = '';
      }
    };
    reader.onerror = () => {
      alert('åœ–ç‰‡è®€å–å¤±æ•—ï¼Œè«‹é‡è©¦ï¼');
      setIsUploading(false);
    };
    reader.readAsDataURL(file);
  };

  const handleSave = () => {
    onSave(bannerTitle, bannerLink, bannerImage);
    onClose();
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
      <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
        <div className="p-6 border-b border-gray-200">
          <h3 className="text-2xl font-black text-slate-800">Banner é…ç½®</h3>
          <p className="text-sm text-slate-500 mt-1">è¨­ç½® Banner åœ–ç‰‡ã€æ¨™é¡Œå’Œè·³è½‰éˆæ¥</p>
        </div>
        
        <div className="p-6 space-y-6">
          {/* Banner æ ‡é¢˜ */}
          <div>
            <label className="block text-sm font-black text-slate-700 mb-2">
              Banner æ¨™é¡Œ <span className="text-xs text-slate-400">(ä¾‹å¦‚ï¼šå‚³èªªå°æ±º v1.0.0)</span>
            </label>
            <input
              type="text"
              value={bannerTitle}
              onChange={(e) => setBannerTitle(e.target.value)}
              className="w-full px-4 py-3 bg-gray-50 rounded-xl border-2 border-gray-200 focus:border-orange-400 focus:outline-none text-slate-700 font-bold"
              placeholder="è¼¸å…¥ Banner æ¨™é¡Œ..."
            />
            <p className="text-xs text-slate-400 mt-1">æ¨™é¡Œå°‡é¡¯ç¤ºåœ¨ Banner åº•éƒ¨ï¼Œè®“å®¢æœç›´è§€äº†è§£ç•¶å‰éŠæˆ²ç‰ˆæœ¬</p>
          </div>

          {/* Banner é“¾æ¥ */}
          <div>
            <label className="block text-sm font-black text-slate-700 mb-2">
              Banner è·³è½‰éˆæ¥ <span className="text-xs text-slate-400">(é¸å¡«)</span>
            </label>
            <input
              type="url"
              value={bannerLink}
              onChange={(e) => setBannerLink(e.target.value)}
              className="w-full px-4 py-3 bg-gray-50 rounded-xl border-2 border-gray-200 focus:border-orange-400 focus:outline-none text-slate-700 font-bold"
              placeholder="https://example.com"
            />
            <p className="text-xs text-slate-400 mt-1">è¨­ç½®å¾Œï¼Œé»æ“Š Banner æˆ–æ¨™é¡Œå°‡è·³è½‰åˆ°è©²éˆæ¥</p>
          </div>

          {/* Banner å›¾ç‰‡ */}
          <div>
            <label className="block text-sm font-black text-slate-700 mb-2">
              Banner åœ–ç‰‡
            </label>
            <div className="flex gap-3">
              <button
                onClick={() => fileInputRef.current?.click()}
                disabled={isUploading}
                className="px-4 py-3 bg-blue-500 hover:bg-blue-600 disabled:bg-blue-300 text-white rounded-xl font-bold text-sm transition-all"
              >
                {isUploading ? 'â³ ä¸Šå‚³ä¸­...' : 'ğŸ“· é¸æ“‡åœ–ç‰‡'}
              </button>
              {bannerImage && (
                <button
                  onClick={() => setBannerImage('')}
                  className="px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold text-sm transition-all"
                >
                  ğŸ—‘ï¸ æ¸…é™¤åœ–ç‰‡
                </button>
              )}
            </div>
            <input
              ref={fileInputRef}
              type="file"
              accept="image/*"
              onChange={handleFileChange}
              className="hidden"
            />
            {bannerImage && (
              <div className="mt-4">
                <img 
                  src={bannerImage} 
                  alt="Banner é è¦½" 
                  className="w-full h-48 object-cover rounded-xl border-2 border-gray-200"
                />
              </div>
            )}
            <p className="text-xs text-slate-400 mt-1">ç•™ç©ºå‰‡ä½¿ç”¨å°é¢åœ–ä½œç‚º Banner</p>
          </div>
        </div>

        <div className="p-6 border-t border-gray-200 flex justify-end gap-3">
          <button
            onClick={onClose}
            className="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-slate-700 rounded-xl font-bold transition-all"
          >
            å–æ¶ˆ
          </button>
          <button
            onClick={handleSave}
            className="px-6 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-xl font-bold transition-all"
          >
            ğŸ’¾ ä¿å­˜
          </button>
        </div>
      </div>
    </div>
  );
};

// Banner ä¸Šä¼ æŒ‰é’®ç»„ä»¶ï¼ˆå¯å¤ç”¨ï¼‰
const BannerUploadButton: React.FC<{
  game: GameKB;
  onUpdateBannerImage: (imageUrl: string) => void;
  onUpdateGame?: (updatedGame: GameKB) => void;
}> = ({ game, onUpdateBannerImage, onUpdateGame }) => {
  const [showConfigModal, setShowConfigModal] = useState(false);

  const handleSaveConfig = (bannerTitle: string, bannerLink: string, bannerImage: string) => {
    if (onUpdateGame) {
      const updatedGame = {
        ...game,
        bannerTitle: bannerTitle.trim() || undefined,
        bannerLink: bannerLink.trim() || undefined,
        bannerImage: bannerImage || undefined,
      };
      onUpdateGame(updatedGame);
    } else {
      // å¦‚æœæ²¡æœ‰ onUpdateGameï¼Œåªæ›´æ–°å›¾ç‰‡
      if (bannerImage) {
        onUpdateBannerImage(bannerImage);
      }
    }
  };

  return (
    <>
      <button
        onClick={() => setShowConfigModal(true)}
        className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-xl font-bold text-sm shadow-lg transition-all"
        title="é…ç½® Bannerï¼ˆåœ–ç‰‡ã€æ¨™é¡Œã€éˆæ¥ï¼‰"
      >
        âš™ï¸ é…ç½® Banner
      </button>
      
      {showConfigModal && (
        <BannerConfigModal
          game={game}
          onClose={() => setShowConfigModal(false)}
          onSave={handleSaveConfig}
        />
      )}
    </>
  );
};

// Banner åŒºåŸŸç»„ä»¶ï¼ˆå¸¦ç‹¬ç«‹ä¸Šä¼ åŠŸèƒ½ï¼‰
const BannerSection: React.FC<{
  game: GameKB;
  isAdminLoggedIn: boolean;
  onUpdateBannerImage: (imageUrl: string) => void;
  onUpdateGame: (updatedGame: GameKB) => void;
  onEditGame: () => void;
}> = ({ game, isAdminLoggedIn, onUpdateBannerImage, onUpdateGame, onEditGame }) => {
  // ä¼˜å…ˆä½¿ç”¨ bannerImageï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ coverImage
  const bannerImageUrl = game.bannerImage || game.coverImage;

  const handleBannerClick = () => {
    if (game.bannerLink) {
      window.open(game.bannerLink, '_blank');
    }
  };

  const handleTitleClick = (e: React.MouseEvent) => {
    e.stopPropagation();
    if (game.bannerLink) {
      window.open(game.bannerLink, '_blank');
    }
  };

  return (
    <div 
      className="relative h-56 rounded-2xl overflow-hidden shadow-lg bg-gradient-to-r from-slate-200 to-slate-300"
      onClick={handleBannerClick}
      style={{ cursor: game.bannerLink ? 'pointer' : 'default' }}
    >
      <img 
        src={bannerImageUrl} 
        className="w-full h-full object-cover" 
        alt={game.name} 
      />
      <div className="absolute inset-0 bg-gradient-to-b from-black/40 via-black/20 to-transparent"></div>
      
      {/* Banner æ ‡é¢˜æ˜¾ç¤º */}
      {game.bannerTitle && (
        <div className="absolute bottom-0 left-0 right-0 p-6 z-10">
          <div 
            onClick={handleTitleClick}
            className={`inline-block px-6 py-3 rounded-xl font-black text-xl text-white shadow-2xl backdrop-blur-sm border-2 border-white/30 ${
              game.bannerLink ? 'hover:bg-white/20 cursor-pointer transition-all hover:scale-105' : ''
            }`}
            style={{
              background: 'linear-gradient(135deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.1) 100%)',
            }}
          >
            {game.bannerTitle}
            {game.bannerLink && (
              <span className="ml-2 text-sm opacity-80">ğŸ”—</span>
            )}
          </div>
        </div>
      )}
      
      {/* ç®¡ç†å‘˜æ“ä½œæŒ‰é’® */}
      {isAdminLoggedIn && (
        <div className="absolute top-4 right-4 flex gap-2 z-20">
          <BannerUploadButton
            game={game}
            onUpdateBannerImage={onUpdateBannerImage}
            onUpdateGame={onUpdateGame}
          />
          
          {/* ç¼–è¾‘æ¸¸æˆæŒ‰é’® */}
          <button
            onClick={(e) => {
              e.stopPropagation();
              onEditGame();
            }}
            className="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-lg transition-all"
            title="ç·¨è¼¯éŠæˆ²"
          >
            âœï¸ ç·¨è¼¯éŠæˆ²
          </button>
        </div>
      )}
    </div>
  );
};

// å­æ¿å—æ˜¾ç¤ºç»„ä»¶
const KBSubItemDisplay: React.FC<{ subItem: KBSubItem; highlight?: boolean }> = ({ subItem, highlight }) => {
  const containerStyle: React.CSSProperties = {};
  if (subItem.backgroundColor) containerStyle.backgroundColor = subItem.backgroundColor;

  return (
    <div
      id={`sub-${subItem.id}`}
      className={`p-4 bg-white rounded-lg border mb-4 transition-all ${highlight ? 'border-orange-500 ring-2 ring-orange-200' : 'border-gray-200'}`}
      style={containerStyle}
    >
      <h5 className="font-bold text-lg mb-3 text-slate-800">
        {subItem.title}
      </h5>
      <div 
        className="leading-relaxed mb-4"
        dangerouslySetInnerHTML={{ __html: subItem.content || '' }}
      />
      
      {/* æ ‡ç­¾ */}
      {subItem.tags && subItem.tags.length > 0 && (
        <div className="flex flex-wrap gap-2 mb-4">
          {subItem.tags.map((tag, idx) => (
            <span key={idx} className="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">
              {tag}
            </span>
          ))}
        </div>
      )}
      
      {/* å•å¼ å›¾ç‰‡ */}
      {subItem.image && (
        <ImageZoom imageUrl={subItem.image} alt={subItem.title} />
      )}
      
      {/* å›¾å†Œ */}
      {subItem.imageGallery && subItem.imageGallery.length > 0 && (
        <ImageGallery images={subItem.imageGallery} />
      )}
      
      {/* è§†é¢‘ */}
      {subItem.video && (
        <div className="my-4">
          <div className="relative w-full rounded-xl overflow-hidden bg-gray-100" style={{ paddingBottom: '56.25%' }}>
            <iframe
              src={subItem.video}
              className="absolute top-0 left-0 w-full h-full"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowFullScreen
            />
          </div>
        </div>
      )}
    </div>
  );
};

// çŸ¥è¯†ç‚¹æ˜¾ç¤ºç»„ä»¶
const KBItemDisplay: React.FC<{ item: KBItem; highlightAnchor?: string }> = ({ item, highlightAnchor }) => {
  const style: React.CSSProperties = {};
  if (item.textColor) style.color = item.textColor;
  if (item.backgroundColor) style.backgroundColor = item.backgroundColor;

  // å¦‚æœæœ‰å­æ¿å—ï¼Œä½¿ç”¨æ–°çš„å±‚çº§ç»“æ„
  if (item.subItems && item.subItems.length > 0) {
    return (
      <div
        id={`item-${item.id}`}
        className={`p-6 bg-gray-50 rounded-xl border hover:bg-white hover:shadow-md transition-all mb-6 ${highlightAnchor === `item-${item.id}` ? 'border-orange-500 ring-2 ring-orange-200' : 'border-gray-200'}`}
        style={style}
      >
        <h4 className="font-bold text-2xl mb-6" style={{ color: item.textColor || 'inherit' }}>
          {item.title}
        </h4>
        <div className="space-y-4">
          {item.subItems.map((subItem) => (
            <KBSubItemDisplay
              key={subItem.id}
              subItem={subItem}
              highlight={highlightAnchor === `sub-${subItem.id}`}
            />
          ))}
        </div>
      </div>
    );
  }

  // å…¼å®¹æ—§æ ¼å¼
  return (
    <div className="p-6 bg-gray-50 rounded-xl border border-gray-200 hover:bg-white hover:shadow-md transition-all" style={style}>
      <h4 className="font-bold text-slate-800 text-lg mb-3" style={{ color: item.textColor || 'inherit' }}>
        {item.title}
      </h4>
      <p className="text-slate-600 leading-relaxed mb-4" style={{ color: item.textColor || 'inherit' }}>
        {item.content}
      </p>
      
      {/* å•å¼ å›¾ç‰‡ */}
      {item.image && (
        <ImageZoom imageUrl={item.image} alt={item.title} />
      )}
      
      {/* å›¾å†Œ */}
      {item.imageGallery && item.imageGallery.length > 0 && (
        <ImageGallery images={item.imageGallery} />
      )}
      
      {/* è§†é¢‘ */}
      {item.video && (
        <div className="my-4">
          <div className="relative w-full rounded-xl overflow-hidden bg-gray-100" style={{ paddingBottom: '56.25%' }}>
            <iframe
              src={item.video}
              className="absolute top-0 left-0 w-full h-full"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowFullScreen
            />
          </div>
        </div>
      )}
      
      {/* æ¸¸æˆæ›´æ–°æƒ…å†µ */}
      {item.gameUpdateInfo && (
        <div className="my-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-r-lg">
          <h5 className="font-bold text-blue-800 mb-2">ğŸ“¢ éŠæˆ²æ›´æ–°æƒ…æ³</h5>
          <p className="text-blue-700 leading-relaxed">{item.gameUpdateInfo}</p>
        </div>
      )}
      
      {/* æ›´å¤šè‡ªå®šä¹‰å†…å®¹ */}
      {item.additionalContent && item.additionalContent.length > 0 && (
        <div className="my-4 space-y-3">
          {item.additionalContent.map((extra, idx) => (
            <div key={idx} className="p-3 bg-gray-100 rounded-lg">
              <h6 className="font-bold text-slate-700 text-sm mb-1">{extra.label}</h6>
              <p className="text-slate-600 text-sm">{extra.value}</p>
            </div>
          ))}
        </div>
      )}
      
      {/* æ ‡ç­¾ */}
      {item.tags && item.tags.length > 0 && (
        <div className="flex gap-2 mt-4 flex-wrap">
          {item.tags.map((tag, idx) => (
            <span key={idx} className="px-2 py-1 bg-orange-100 text-orange-600 text-xs rounded-full">
              {tag}
            </span>
          ))}
        </div>
      )}
    </div>
  );
};

// ä»URLå‚æ•°è§£æé¡µé¢çŠ¶æ€
const parseUrlState = (pathname: string, games: GameKB[]): {
  category: GameCategory | 'HOME' | 'ADMIN' | 'SEARCH';
  gameId?: string;
  section?: string;
} => {
  if (pathname === '/admin' || pathname.startsWith('/admin')) {
    return { category: 'ADMIN' };
  }
  if (pathname === '/search') {
    return { category: 'SEARCH' };
  }
  if (pathname.startsWith('/game/')) {
    const parts = pathname.split('/');
    const gameId = parts[2];
    const section = parts[3] || undefined;
    return { category: 'HOME', gameId, section };
  }
  if (pathname === '/online') {
    return { category: GameCategory.ONLINE };
  }
  if (pathname === '/mobile') {
    return { category: GameCategory.MOBILE };
  }
  return { category: 'HOME' };
};

const AppContent: React.FC = () => {
  const navigate = useNavigate();
  const location = useLocation();
  
  // ä»localStorageåŠ è½½æ¸¸æˆæ•°æ®
  const loadGamesFromStorage = (): GameKB[] => {
    try {
      const saved = localStorage.getItem('gamesData');
      if (saved) {
        return JSON.parse(saved);
      }
    } catch (e) {
      console.error('Failed to load games from storage:', e);
    }
    return INITIAL_GAMES;
  };

  // ä¿å­˜æ¸¸æˆæ•°æ®åˆ°localStorage
  const saveGamesToStorage = (gamesData: GameKB[]) => {
    try {
      localStorage.setItem('gamesData', JSON.stringify(gamesData));
    } catch (e) {
      console.error('Failed to save games to storage:', e);
    }
  };

  const [games, setGames] = useState<GameKB[]>(loadGamesFromStorage());
  const [activeCategory, setActiveCategory] = useState<GameCategory | 'HOME' | 'ADMIN' | 'SEARCH'>('HOME');
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedGame, setSelectedGame] = useState<GameKB | null>(null);
  const [selectedGameSection, setSelectedGameSection] = useState<string | null>(null);
  const [activeSection, setActiveSection] = useState<SectionType>(SectionType.CONTACT);
  const [isAdminLoggedIn, setIsAdminLoggedIn] = useState(false);
  const [customSectionTypes, setCustomSectionTypes] = useState<CustomSectionType[]>(getCustomSectionTypes());
  
  // useEffect å·²ä»¥ URL ä¸ºå”¯ä¸€çœŸç›¸ï¼Œè¿™ä¸ª ref ä¸å†éœ€è¦ï¼ˆä¿ç•™å¯åç»­åˆ é™¤ï¼‰
  const lastPathnameRef = useRef<string>('');

  // updateUrl å‡½æ•°ï¼šæ›´æ–° URL è·¯å¾„ï¼ˆURL ä½œä¸ºå”¯ä¸€çœŸç›¸ï¼‰
  const updateUrl = (category: GameCategory | 'HOME' | 'ADMIN' | 'SEARCH', gameId?: string, section?: string, query?: string) => {
    let path = '/';

    if (category === 'ADMIN') {
      path = '/admin';
    } else if (category === 'SEARCH') {
      const q = (query || '').trim();
      path = q ? `/search?q=${encodeURIComponent(q)}` : '/search';
    } else if (category === GameCategory.ONLINE) {
      path = '/online';
    } else if (category === GameCategory.MOBILE) {
      path = '/mobile';
    } else if (gameId) {
      // æ¸¸æˆè¯¦æƒ…/åˆ†åŒºé¡µå¿…é¡»ä½¿ç”¨ /game/...ï¼Œä¸èƒ½å¤ç”¨ /mobile
      path = section
        ? `/game/${gameId}/${encodeURIComponent(section)}`
        : `/game/${gameId}`;
    }

    navigate(path);
  };

  // å½“gamesæ›´æ–°æ—¶ï¼Œä¿å­˜åˆ°localStorage
  useEffect(() => {
    saveGamesToStorage(games);
  }, [games]);

  // æ ¹æ® URL æ›´æ–°çŠ¶æ€ï¼šURL æ˜¯å”¯ä¸€çœŸç›¸
  useEffect(() => {
    const state = parseUrlState(location.pathname, games);

    const url = new URL(window.location.href);
    const q = url.searchParams.get('q') || '';

    // /game/... éœ€è¦å…ˆæœ‰ games æ‰èƒ½å®šä½åˆ°å…·ä½“æ¸¸æˆ
    if (state.gameId && games.length === 0) {
      return;
    }

    if (state.category === 'SEARCH') {
      setSelectedGame(null);
      setSelectedGameSection(null);
      setActiveCategory('SEARCH');
      setSearchQuery(q);
      return;
    }

    if (state.gameId) {
      const game = games.find(g => g.id === state.gameId) || null;
      if (!game) {
        navigate('/', { replace: true });
        return;
      }
      setSelectedGame(game);
      setSelectedGameSection(state.section ? decodeURIComponent(state.section) : null);
      setActiveCategory(game.category);
      return;
    }

    setSelectedGame(null);
    setSelectedGameSection(null);
    setActiveCategory(state.category);
  }, [location.pathname, games, navigate]);


  // æ£€æŸ¥ç™»å½•çŠ¶æ€
  useEffect(() => {
    const checkLoginStatus = () => {
      const loggedIn = localStorage.getItem('adminLoggedIn') === 'true';
      const loginTime = localStorage.getItem('adminLoginTime');
      
      // æ£€æŸ¥æ˜¯å¦åœ¨24å°æ—¶å†…ç™»å½•ï¼ˆå¯é€‰ï¼šè®¾ç½®ç™»å½•è¿‡æœŸæ—¶é—´ï¼‰
      if (loggedIn && loginTime) {
        const timeDiff = Date.now() - parseInt(loginTime);
        const hoursDiff = timeDiff / (1000 * 60 * 60);
        
        // 24å°æ—¶åè‡ªåŠ¨ç™»å‡ºï¼ˆå¯é€‰ï¼‰
        if (hoursDiff < 24) {
          setIsAdminLoggedIn(true);
        } else {
          localStorage.removeItem('adminLoggedIn');
          localStorage.removeItem('adminLoginTime');
          setIsAdminLoggedIn(false);
        }
      } else {
        setIsAdminLoggedIn(false);
      }
    };

    checkLoginStatus();
  }, []);

  const handleLogin = () => {
    setIsAdminLoggedIn(true);
    updateUrl('ADMIN');
  };

  const handleLogout = () => {
    localStorage.removeItem('adminLoggedIn');
    localStorage.removeItem('adminLoginTime');
    setIsAdminLoggedIn(false);
    if (activeCategory === 'ADMIN') {
      setActiveCategory('HOME');
      updateUrl('HOME');
      return;
    }
  };

  const renderSearchContent = () => {
    if (activeCategory === 'SEARCH') {
      const query = searchQuery.trim();

      // åªéœ€è¦æ¯ä¸ªæ¸¸æˆä¸€ä¸ªâ€œæœ€ç›¸å…³â€çš„å‘½ä¸­
      const normalize = (s: string) => (s || '').toLowerCase();
      const qn = normalize(query);

      type Hit = {
        gameId: string;
        gameName: string;
        gameCategory: GameCategory;
        sectionType: string;
        itemId: string;
        itemTitle: string;
        subItemId?: string;
        subItemTitle?: string;
        snippet: string;
        matchSource: 'itemTitle' | 'subItemTitle' | 'subItemContent';
        score: number;
      };

      const bestByGame = new Map<string, Hit>();

      const calcScore = (src: Hit['matchSource']) => {
        // ä¼˜å…ˆå­ç‰ˆå—æ ‡é¢˜ > å­ç‰ˆå—å†…å®¹ > å¤§æ ‡é¢˜
        if (src === 'subItemTitle') return 30;
        if (src === 'subItemContent') return 20;
        return 10;
      };

      if (qn) {
        games.forEach((g) => {
          g.sections.forEach((sec) => {
            const secName = String(sec.type);

            sec.items.forEach((item) => {
              // å¤§æ ‡é¢˜
              if (normalize(item.title).includes(qn)) {
                const hit: Hit = {
                  gameId: g.id,
                  gameName: g.name,
                  gameCategory: g.category,
                  sectionType: secName,
                  itemId: item.id,
                  itemTitle: item.title,
                  snippet: item.title,
                  matchSource: 'itemTitle',
                  score: calcScore('itemTitle'),
                };
                const prev = bestByGame.get(g.id);
                if (!prev || hit.score > prev.score) bestByGame.set(g.id, hit);
              }

              // å­ç‰ˆå—
              (item.subItems || []).forEach((sub) => {
                const subTitleHit = normalize(sub.title).includes(qn);
                const subContentHit = normalize(sub.content || '').includes(qn);

                if (subTitleHit || subContentHit) {
                  const src: Hit['matchSource'] = subTitleHit ? 'subItemTitle' : 'subItemContent';
                  const hit: Hit = {
                    gameId: g.id,
                    gameName: g.name,
                    gameCategory: g.category,
                    sectionType: secName,
                    itemId: item.id,
                    itemTitle: item.title,
                    subItemId: sub.id,
                    subItemTitle: sub.title,
                    snippet: subContentHit ? (sub.content || '').slice(0, 80) : sub.title,
                    matchSource: src,
                    score: calcScore(src),
                  };

                  const prev = bestByGame.get(g.id);
                  if (!prev || hit.score > prev.score) bestByGame.set(g.id, hit);
                }
              });
            });
          });
        });
      }

      const results = Array.from(bestByGame.values()).sort((a, b) => b.score - a.score);

      return (
        <div className="space-y-6 animate-in fade-in zoom-in-95 duration-500">
          <div className="bg-white rounded-2xl shadow-lg p-8">
            <h2 className="text-3xl font-black text-slate-800 mb-2">æœå°‹çµæœ</h2>
            <p className="text-slate-500 text-sm">é—œéµå­—ï¼š<span className="font-black">{query || 'ï¼ˆç©ºï¼‰'}</span></p>

            <div className="mt-6">
              {query.trim().length === 0 ? (
                <div className="text-slate-400 italic">è«‹è¼¸å…¥é—œéµå­—ï¼Œä¾‹å¦‚ã€Œç™»å…¥ã€</div>
              ) : results.length === 0 ? (
                <div className="text-slate-400 italic">æœªæœ‰æœåˆ°è©²å…§å®¹</div>
              ) : (
                <div className="space-y-3">
                  {results.map((m, idx) => (
                    <button
                      key={idx}
                      onClick={() => {
                        // åªæ˜¾ç¤ºæ¯ä¸ªæ¸¸æˆä¸€æ¡ï¼šç›´æ¥è·³åˆ°æœ€ç›¸å…³çš„å‘½ä¸­ä½ç½®
                        const anchor = m.subItemId ? `sub-${m.subItemId}` : `item-${m.itemId}`;
                        const q = searchQuery.trim();
                        navigate(`/game/${m.gameId}/${encodeURIComponent(m.sectionType)}?anchor=${encodeURIComponent(anchor)}&q=${encodeURIComponent(q)}`);
                      }}
                      className="w-full text-left p-4 rounded-xl border border-gray-200 hover:bg-gray-50 transition-all"
                    >
                      <div className="flex items-center justify-between gap-4">
                        <div className="font-black text-slate-800">{m.gameName}</div>
                        <div className="text-[10px] font-black px-2 py-1 rounded-full bg-gray-100 text-slate-600">{m.gameCategory}</div>
                      </div>
                      <div className="mt-1 text-sm font-bold text-orange-600">{m.sectionType}</div>
                      <div className="mt-1 text-xs text-slate-500">
                        {m.itemTitle}{m.subItemTitle ? ` / ${m.subItemTitle}` : ''}
                      </div>
                      <div className="mt-2 text-sm text-slate-600">{m.snippet}</div>
                    </button>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    return null;
  };

  const handleAddGame = (newGame: GameKB) => {
    setGames([...games, newGame]);
    setActiveCategory('HOME');
    updateUrl('HOME');
  };

  const handleUpdateGame = (updatedGame: GameKB) => {
    setGames(games.map(game => game.id === updatedGame.id ? updatedGame : game));
  };

  const handleUpdateGameSection = (gameId: string, sectionType: string, items: KBItem[]) => {
    setGames(games.map(game => {
      if (game.id === gameId) {
        // æ£€æŸ¥sectionæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
        const existingSection = game.sections.find(s => s.type === sectionType);
        if (!existingSection) {
          // æ·»åŠ æ–°çš„section
          return {
            ...game,
            sections: [...game.sections, { type: sectionType as SectionType, items }]
          };
        }
        // æ›´æ–°ç°æœ‰section
        return {
          ...game,
          sections: game.sections.map(section => 
            section.type === sectionType 
              ? { ...section, items }
              : section
          )
        };
      }
      return game;
    }));
  };

  const handleAddSectionType = (name: string) => {
    const trimmedName = name.trim();
    if (!trimmedName) return;
    
    const allTypes = getAllAvailableSectionTypes();
    if (allTypes.includes(trimmedName)) {
      alert('è©²æ¿å¡Šé¡å‹å·²å­˜åœ¨ï¼');
      return;
    }
    
    const newAllTypes = [...allTypes, trimmedName];
    saveAllSectionTypes(newAllTypes);
    
    // æ›´æ–°customSectionTypesï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
    const customTypes = getCustomSectionTypes();
    const newCustomType: CustomSectionType = {
      id: Date.now().toString(),
      name: trimmedName
    };
    const updatedCustomTypes = [...customTypes, newCustomType];
    setCustomSectionTypes(updatedCustomTypes);
    
    // ä¸ºæ‰€æœ‰æ¸¸æˆæ·»åŠ è¿™ä¸ªæ–°çš„section
    const updatedGames = games.map(game => ({
      ...game,
      sections: [...game.sections, { type: trimmedName as SectionType, items: [] }]
    }));
    setGames(updatedGames);
    saveGamesToStorage(updatedGames);
    
    alert(`âœ… å·²æ–°å¢æ¿å¡Šé¡å‹ã€Œ${trimmedName}ã€ï¼`);
  };

  const handleDeleteSectionType = (typeName: string) => {
    if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${typeName}ã€å—ï¼Ÿé€™å°‡åˆªé™¤æ‰€æœ‰éŠæˆ²ä¸­è©²æ¿å¡Šçš„æ‰€æœ‰çŸ¥è­˜é»ï¼`)) {
      return;
    }
    
    const allTypes = getAllAvailableSectionTypes();
    const newAllTypes = allTypes.filter(t => t !== typeName);
    saveAllSectionTypes(newAllTypes);
    
    // æ›´æ–°customSectionTypesï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
    const updatedCustomTypes = customSectionTypes.filter(t => t.name !== typeName);
    setCustomSectionTypes(updatedCustomTypes);
    
    // ä»æ‰€æœ‰æ¸¸æˆä¸­åˆ é™¤è¿™ä¸ªsection
    const updatedGames = games.map(game => ({
      ...game,
      sections: game.sections.filter(s => s.type !== typeName)
    }));
    setGames(updatedGames);
    saveGamesToStorage(updatedGames);
    
    alert(`âœ… å·²åˆªé™¤æ¿å¡Šé¡å‹ã€Œ${typeName}ã€ï¼`);
  };

  const handleRenameSectionType = (oldName: string, newName: string) => {
    const trimmedNewName = newName.trim();
    if (!trimmedNewName) {
      alert('åç¨±ä¸èƒ½ç‚ºç©ºï¼');
      return;
    }
    
    if (trimmedNewName === oldName) {
      return;
    }

    const allTypes = getAllAvailableSectionTypes();
    if (allTypes.includes(trimmedNewName)) {
      alert('è©²æ¿å¡Šé¡å‹åç¨±å·²å­˜åœ¨ï¼');
      return;
    }

    // æ›´æ–°å…¨å±€æ¿å—ç±»å‹åˆ—è¡¨
    const newAllTypes = allTypes.map(t => t === oldName ? trimmedNewName : t);
    saveAllSectionTypes(newAllTypes);
    
    // æ›´æ–°customSectionTypesï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
    const updatedCustomTypes = customSectionTypes.map(t => 
      t.name === oldName ? { ...t, name: trimmedNewName } : t
    );
    setCustomSectionTypes(updatedCustomTypes);
    
    // æ›´æ–°æ‰€æœ‰æ¸¸æˆä¸­çš„æ¿å—ç±»å‹åç§°
    const updatedGames = games.map(game => ({
      ...game,
      sections: game.sections.map(section => 
        section.type === oldName 
          ? { ...section, type: trimmedNewName as SectionType }
          : section
      )
    }));
    setGames(updatedGames);
    saveGamesToStorage(updatedGames);
    
    alert(`âœ… å·²å°‡ã€Œ${oldName}ã€é‡å‘½åç‚ºã€Œ${trimmedNewName}ã€ï¼`);
  };

  // ä¿æŒå‘åå…¼å®¹
  const handleAddCustomSectionType = (name: string) => {
    handleAddSectionType(name);
  };

  const handleDeleteCustomSectionType = (id: string) => {
    const typeToDelete = customSectionTypes.find(t => t.id === id);
    if (typeToDelete) {
      handleDeleteSectionType(typeToDelete.name);
    }
  };

  // è·å–æ¸¸æˆæ’åºï¼ˆä»localStorageï¼‰
  const getGameOrder = (): string[] => {
    return JSON.parse(localStorage.getItem('gameOrder') || '[]') as string[];
  };

  // ä¿å­˜æ¸¸æˆæ’åº
  const saveGameOrder = (order: string[]) => {
    localStorage.setItem('gameOrder', JSON.stringify(order));
  };

  // æ ¹æ®æ’åºå¯¹æ¸¸æˆè¿›è¡Œæ’åº
  const getSortedGames = (gameList: GameKB[]): GameKB[] => {
    const order = getGameOrder();
    if (order.length === 0) return gameList;
    
    const ordered: GameKB[] = [];
    const unordered: GameKB[] = [];
    
    // å…ˆæŒ‰é¡ºåºæ·»åŠ 
    order.forEach(id => {
      const game = gameList.find(g => g.id === id);
      if (game) ordered.push(game);
    });
    
    // å†æ·»åŠ æœªæ’åºçš„
    gameList.forEach(game => {
      if (!order.includes(game.id)) {
        unordered.push(game);
      }
    });
    
    return [...ordered, ...unordered];
  };

  const handleMoveGame = (gameId: string, direction: 'up' | 'down', category?: GameCategory) => {
    const gameList = category 
      ? games.filter(g => g.category === category)
      : activeCategory === 'HOME' 
        ? games 
        : games.filter(g => g.category === activeCategory);
    
    const sortedGames = getSortedGames(gameList);
    const currentIndex = sortedGames.findIndex(g => g.id === gameId);
    if (currentIndex === -1) return;
    
    const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
    if (newIndex < 0 || newIndex >= sortedGames.length) return;
    
    // äº¤æ¢ä½ç½®
    const currentOrder = getGameOrder();
    const allGameIds = games.map(g => g.id);
    let newOrder = [...currentOrder];
    
    // ç¡®ä¿æ‰€æœ‰æ¸¸æˆIDéƒ½åœ¨orderä¸­
    allGameIds.forEach(id => {
      if (!newOrder.includes(id)) {
        newOrder.push(id);
      }
    });
    
    // äº¤æ¢ä½ç½®
    const gameId1 = sortedGames[currentIndex].id;
    const gameId2 = sortedGames[newIndex].id;
    const index1 = newOrder.indexOf(gameId1);
    const index2 = newOrder.indexOf(gameId2);
    [newOrder[index1], newOrder[index2]] = [newOrder[index2], newOrder[index1]];
    
    saveGameOrder(newOrder);
    // è§¦å‘é‡æ–°æ¸²æŸ“
    setGames([...games]);
  };

  const filteredGames = activeCategory === 'HOME' 
    ? games 
    : games.filter(g => g.category === activeCategory);
  
  const sortedFilteredGames = getSortedGames(filteredGames);

  const renderContent = () => {
    // æœç´¢é¡µ
    if (activeCategory === 'SEARCH') {
      return renderSearchContent();
    }

    // ä¼˜å…ˆæ£€æŸ¥ selectedGameï¼Œç¡®ä¿æ¸¸æˆè¯¦æƒ…é¡µä¼˜å…ˆæ˜¾ç¤º
    if (selectedGame) {
      // è·å–æ‰€æœ‰æ¿å—ç±»å‹ï¼ˆåŒ…æ‹¬è‡ªå®šä¹‰çš„ï¼‰
      const gameSectionButtons = getAllSectionTypes();

      // å¦‚æœé€‰æ‹©äº†æŸä¸ªåˆ†ç±»ï¼Œæ˜¾ç¤ºè¯¥åˆ†ç±»çš„å†…å®¹
      if (selectedGameSection) {
        const url = new URL(window.location.href);
        const highlightAnchor = url.searchParams.get('anchor') || undefined;
        const section = selectedGame.sections.find(s => s.type === selectedGameSection);
        const gameSectionButtons = getAllSectionTypes();

        // è‡ªåŠ¨æ»šåŠ¨å®šä½ï¼ˆç”¨äºæœç´¢ç»“æœç‚¹å‡»åï¼‰
        if (highlightAnchor) {
          setTimeout(() => {
            const el = document.getElementById(highlightAnchor);
            if (el) {
              el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }, 50);
        }

        return (
          <div className="space-y-6 animate-in fade-in zoom-in-95 duration-500">
            <button
              onClick={() => updateUrl('HOME', selectedGame.id)}
              className="text-orange-600 font-bold text-sm hover:underline"
            >
              â† è¿”å›éŠæˆ²é¦–é 
            </button>

            {/* Banner åŒºåŸŸ - å¯ä»¥æ›¿æ¢ä¸ºè‡ªå®šä¹‰å›¾ç‰‡ */}
            <BannerSection 
              game={selectedGame}
              isAdminLoggedIn={isAdminLoggedIn}
              onUpdateBannerImage={(imageUrl) => {
                const updatedGame = { ...selectedGame, bannerImage: imageUrl };
                handleUpdateGame(updatedGame);
                setSelectedGame(updatedGame);
              }}
              onUpdateGame={(updatedGame) => {
                handleUpdateGame(updatedGame);
                setSelectedGame(updatedGame);
              }}
              onEditGame={() => {
                const gameToEdit = games.find(g => g.id === selectedGame.id);
                if (gameToEdit) {
                  // å…ˆæ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
                  window.scrollTo({ top: 0, behavior: 'smooth' });
                  setActiveCategory('ADMIN');
                  updateUrl('ADMIN');
                  setTimeout(() => {
                    const gameCard = document.querySelector(`[data-game-id="${selectedGame.id}"]`);
                    if (gameCard) {
                      gameCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                      const editButton = gameCard.querySelector('button') as HTMLButtonElement;
                      if (editButton && editButton.textContent?.includes('ç·¨è¼¯')) {
                        editButton.click();
                      }
                    }
                  }, 300);
                }
              }}
            />

            {/* åˆ†ç±»åˆ‡æ¢æŒ‰é’® - ç­‰é—´è·æ’å¸ƒ */}
            <div className="flex justify-between gap-4 overflow-x-auto pb-2 scrollbar-hide">
              {gameSectionButtons.map((sectionType) => {
                const sectionData = selectedGame.sections.find(s => s.type === sectionType);
                const hasContent = sectionData && sectionData.items.length > 0;
                const isActive = selectedGameSection === sectionType;
                return (
                  <button
                    key={sectionType}
                    onClick={() => {
                      if (hasContent && selectedGame) {
                        updateUrl('HOME', selectedGame.id, sectionType);
                      }
                    }}
                    className={`flex-1 px-6 py-3 rounded-xl font-bold text-base whitespace-nowrap transition-all ${
                      isActive
                        ? 'bg-gradient-to-r from-pink-500 to-red-500 text-white shadow-lg'
                        : hasContent
                        ? 'bg-white text-slate-600 hover:bg-gray-100 shadow-sm'
                        : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                    }`}
                    disabled={!hasContent}
                  >
                    {sectionType}
                  </button>
                );
              })}
            </div>

            {/* å†…å®¹åŒºåŸŸ */}
            <div className="bg-white rounded-2xl shadow-lg p-8 min-h-[500px]">
              <h2 className="text-3xl font-black text-slate-800 mb-6 flex items-center gap-3">
                <span className="w-2 h-8 bg-gradient-to-b from-pink-500 to-red-500 rounded-full"></span>
                {selectedGameSection}
              </h2>
              <div className="space-y-4">
                {section && section.items.length > 0 ? section.items.map(item => (
                  <KBItemDisplay key={item.id} item={item} highlightAnchor={highlightAnchor} />
                )) : (
                  <div className="py-20 text-center text-slate-400 italic">
                    <p className="text-lg">æš«ç„¡çŸ¥è­˜é»</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      // æ˜¾ç¤ºæ¸¸æˆæ¿å—å’ŒæŒ‰é’®ï¼ˆæ¸¸æˆè¯¦æƒ…é¡µï¼‰
      const gameBannerImage = selectedGame.bannerImage || selectedGame.coverImage;
      return (
        <div className="space-y-8 animate-in fade-in zoom-in-95 duration-500">
          <button 
            onClick={() => {
              // æ¸¸æˆè¯¦æƒ…é¡µè¿”å›åˆ°æ‰€å±åˆ†ç±»åˆ—è¡¨
              updateUrl(selectedGame.category);
            }}
            className="text-orange-600 font-bold text-sm hover:underline"
          >
            â† è¿”å›{selectedGame.category}
          </button>
          
          <div 
            className="relative h-64 rounded-3xl overflow-hidden shadow-xl border-4 border-white"
            onClick={() => {
              if (selectedGame.bannerLink) {
                window.open(selectedGame.bannerLink, '_blank');
              }
            }}
            style={{ cursor: selectedGame.bannerLink ? 'pointer' : 'default' }}
          >
            <img src={gameBannerImage} className="w-full h-full object-cover" alt={selectedGame.name} />
            <div className="absolute inset-0 bg-gradient-to-r from-white/90 via-white/20 to-transparent flex items-center p-12">
              <div className="flex-1">
                <span className="px-3 py-1 bg-orange-500 text-white rounded-full text-[10px] font-black mb-3 inline-block">
                  {selectedGame.category}
                </span>
                <h2 className="text-5xl font-black text-slate-800 acg-title">{selectedGame.name}</h2>
                {selectedGame.bannerTitle && (
                  <div 
                    className="mt-4 inline-block px-6 py-2 bg-white/80 backdrop-blur-sm rounded-xl font-black text-lg text-slate-800 shadow-lg border-2 border-white/50"
                    onClick={(e) => {
                      e.stopPropagation();
                      if (selectedGame.bannerLink) {
                        window.open(selectedGame.bannerLink, '_blank');
                      }
                    }}
                    style={{ cursor: selectedGame.bannerLink ? 'pointer' : 'default' }}
                  >
                    {selectedGame.bannerTitle}
                    {selectedGame.bannerLink && (
                      <span className="ml-2 text-sm opacity-60">ğŸ”—</span>
                    )}
                  </div>
                )}
              </div>
              {isAdminLoggedIn && (
                <div className="flex gap-2">
                  <BannerUploadButton
                    game={selectedGame}
                    onUpdateBannerImage={(imageUrl) => {
                      const updatedGame = { ...selectedGame, bannerImage: imageUrl };
                      handleUpdateGame(updatedGame);
                      setSelectedGame(updatedGame);
                    }}
                    onUpdateGame={(updatedGame) => {
                      handleUpdateGame(updatedGame);
                      setSelectedGame(updatedGame);
                    }}
                  />
                </div>
              )}
            </div>
          </div>

          {/* æ¸¸æˆæ¿å—æŒ‰é’® */}
          <div className="grid grid-cols-2 gap-4 mt-8">
            {gameSectionButtons.map((sectionType) => {
              const section = selectedGame.sections.find(s => s.type === sectionType);
              const hasContent = section && section.items.length > 0;
              return (
                <button
                  key={sectionType}
                  onClick={() => updateUrl('HOME', selectedGame.id, sectionType)}
                  className={`w-full py-4 rounded-2xl font-bold text-lg transition-all ${
                    hasContent 
                      ? 'bg-gradient-to-r from-pink-500 to-red-500 text-white shadow-lg hover:shadow-xl hover:scale-[1.02] active:scale-[0.98]' 
                      : 'bg-gradient-to-r from-pink-200 to-red-200 text-pink-300 cursor-not-allowed'
                  }`}
                  disabled={!hasContent}
                >
                  {sectionType}
                </button>
              );
            })}
          </div>
        </div>
      );
    }

    // ç®¡ç†é¡µ
    if (activeCategory === 'ADMIN') {
      if (!isAdminLoggedIn) {
        return <Login onLogin={handleLogin} />;
      }
      return <AdminPanel 
        games={games} 
        onAddGame={handleAddGame} 
        onUpdateGame={handleUpdateGame}
        onUpdateGameSection={handleUpdateGameSection}
        onLogout={handleLogout}
        customSectionTypes={customSectionTypes}
        onAddCustomSectionType={handleAddCustomSectionType}
        onDeleteCustomSectionType={handleDeleteCustomSectionType}
        editingGameId={selectedGame?.id}
        getAllSectionTypes={getAllSectionTypes}
        onAddSectionType={handleAddSectionType}
        onDeleteSectionType={handleDeleteSectionType}
        onRenameSectionType={handleRenameSectionType}
      />;
    }

    // åˆ†ç±»åˆ—è¡¨é¡µ
    if (activeCategory === GameCategory.ONLINE) {
      const onlineGames = games.filter(g => g.category === GameCategory.ONLINE);
      return (
        <div className="space-y-12 animate-in fade-in zoom-in-95 duration-500">
          <section className="text-center space-y-4">
            <div className="flex items-center justify-center gap-4 mb-4">
              <span className="w-2 h-12 bg-orange-600 rounded-full"></span>
              <h1 className="text-6xl font-black text-slate-800 acg-title">ç·šä¸ŠéŠæˆ²</h1>
            </div>
          </section>

          {onlineGames.length > 0 ? (
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
              {getSortedGames(onlineGames).map((game, index) => (
                <div key={game.id} className="relative group glass-card rounded-[2.5rem] overflow-hidden">
                  <div
                    onClick={() => updateUrl('HOME', game.id)}
                    className="cursor-pointer"
                  >
                    <div className="h-56 relative overflow-hidden">
                      <img src={game.coverImage} className="w-full h-full object-cover" alt={game.name} />
                    </div>
                    <div className="p-8">
                      <h3 className="text-2xl font-black text-slate-800 mb-4">{game.name}</h3>
                      <div className="grid grid-cols-2 gap-3">
                        {getAllSectionTypes().map((sectionType) => {
                          const section = game.sections.find(s => s.type === sectionType);
                          const hasContent = section && section.items.length > 0;
                          return (
                            <button
                              key={sectionType}
                              onClick={(e) => {
                                e.stopPropagation();
                                if (hasContent) {
                                  updateUrl('HOME', game.id, sectionType);
                                } else {
                                  updateUrl('HOME', game.id);
                                }
                              }}
                              className={`w-full py-2.5 rounded-xl text-sm font-bold transition-all ${
                                hasContent 
                                  ? 'bg-gradient-to-r from-pink-500 to-red-500 text-white'
                                  : 'bg-gradient-to-r from-pink-200 to-red-200 text-pink-300 cursor-not-allowed'
                              }`}
                              disabled={!hasContent}
                            >
                              {sectionType}
                            </button>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="text-center py-20">
              <p className="text-slate-400 text-lg">æš«ç„¡ç·šä¸ŠéŠæˆ²è³‡æ–™</p>
            </div>
          )}
        </div>
      );
    }

    if (activeCategory === GameCategory.MOBILE) {
      const mobileGames = games.filter(g => g.category === GameCategory.MOBILE);
      return (
        <div className="space-y-12 animate-in fade-in zoom-in-95 duration-500">
          <section className="text-center space-y-4">
            <div className="flex items-center justify-center gap-4 mb-4">
              <span className="w-2 h-12 bg-blue-600 rounded-full"></span>
              <h1 className="text-6xl font-black text-slate-800 acg-title">æ‰‹æ©ŸéŠæˆ²</h1>
            </div>
          </section>

          {mobileGames.length > 0 ? (
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
              {getSortedGames(mobileGames).map((game, index) => (
                <div key={game.id} className="relative group glass-card rounded-[2.5rem] overflow-hidden">
                  <div className="cursor-pointer">
                    <div 
                      className="h-56 relative overflow-hidden"
                      onClick={(e) => {
                        if (game.officialWebsite) {
                          e.stopPropagation();
                          window.open(game.officialWebsite, '_blank');
                        } else {
                          updateUrl('HOME', game.id);
                        }
                      }}
                    >
                      <img src={game.coverImage} className="w-full h-full object-cover" alt={game.name} />
                    </div>
                    <div className="p-8">
                      <h3 className="text-2xl font-black text-slate-800 mb-4" onClick={() => updateUrl('HOME', game.id)}>{game.name}</h3>
                      <div className="grid grid-cols-2 gap-3">
                        {getAllSectionTypes().map((sectionType) => {
                          const section = game.sections.find(s => s.type === sectionType);
                          const hasContent = section && section.items.length > 0;
                          return (
                            <button
                              key={sectionType}
                              onClick={(e) => {
                                e.stopPropagation();
                                if (hasContent) {
                                  updateUrl('HOME', game.id, sectionType);
                                } else {
                                  updateUrl('HOME', game.id);
                                }
                              }}
                              className={`w-full py-2.5 rounded-xl text-sm font-bold transition-all ${
                                hasContent 
                                  ? 'bg-gradient-to-r from-pink-500 to-red-500 text-white'
                                  : 'bg-gradient-to-r from-pink-200 to-red-200 text-pink-300 cursor-not-allowed'
                              }`}
                              disabled={!hasContent}
                            >
                              {sectionType}
                            </button>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="text-center py-20">
              <p className="text-slate-400 text-lg">æš«ç„¡æ‰‹æ©ŸéŠæˆ²è³‡æ–™</p>
            </div>
          )}
        </div>
      );
    }

    // é¦–é¡µ
    return (
      <div className="space-y-16">
        <section className="text-center space-y-4">
          <h1 className="text-6xl font-black text-slate-800 acg-title">éŠæˆ²çŸ¥è­˜åº«</h1>
        </section>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div 
            onClick={() => updateUrl(GameCategory.ONLINE)}
            className="group relative h-72 rounded-[2.5rem] overflow-hidden cursor-pointer glass-card"
          >
            <div className="absolute inset-0 bg-gradient-to-br from-orange-400/20 to-transparent z-10"></div>
            <img 
              src="https://images.unsplash.com/photo-1542751371-adc38448a05e?q=80&w=2070&auto=format&fit=crop" 
              className="absolute inset-0 w-full h-full object-cover opacity-60" 
              alt="Online" 
            />
            <div className="absolute inset-0 p-10 z-20 flex flex-col justify-between">
              <h2 className="text-4xl font-black text-slate-800 flex items-center gap-4">
                <span className="w-2 h-10 bg-orange-600 rounded-full"></span>
                ç·šä¸ŠéŠæˆ²
              </h2>
            </div>
          </div>

          <div 
            onClick={() => updateUrl(GameCategory.MOBILE)}
            className="group relative h-72 rounded-[2.5rem] overflow-hidden cursor-pointer glass-card"
          >
            <div className="absolute inset-0 bg-gradient-to-br from-blue-400/20 to-transparent z-10"></div>
            <img 
              src="https://images.unsplash.com/photo-1614850523296-d8c1af93d400?q=80&w=2070&auto=format&fit=crop" 
              className="absolute inset-0 w-full h-full object-cover opacity-60" 
              alt="Mobile" 
            />
            <div className="absolute inset-0 p-10 z-20 flex flex-col justify-between">
              <h2 className="text-4xl font-black text-slate-800 flex items-center gap-4">
                <span className="w-2 h-10 bg-blue-600 rounded-full"></span>
                æ‰‹æ©ŸéŠæˆ²
              </h2>
            </div>
          </div>
        </div>

        <section className="space-y-10 pt-12">
          <div className="flex items-end justify-between">
            <h2 className="text-3xl font-black text-slate-800 flex items-center gap-4">
              <span className="w-2 h-10 btn-orange rounded-full"></span>
              å…¨éƒ¨éŠæˆ²æ¿å¡Š
            </h2>
          </div>

          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
            {sortedFilteredGames.map((game, index) => (
              <div key={game.id} className="relative group glass-card rounded-[2.5rem] overflow-hidden">
                <div className="cursor-pointer">
                  <div 
                    className="h-56 relative overflow-hidden"
                    onClick={(e) => {
                      if (game.officialWebsite) {
                        e.stopPropagation();
                        window.open(game.officialWebsite, '_blank');
                      } else {
                        updateUrl('HOME', game.id);
                      }
                    }}
                  >
                    <img src={game.coverImage} className="w-full h-full object-cover" alt={game.name} />
                    {game.officialWebsite && (
                      <div className="absolute bottom-4 left-4 bg-black/70 text-white px-4 py-2 rounded-full text-xs font-bold backdrop-blur-sm">
                        ğŸŒ é»æ“Šå‰å¾€å®˜ç¶²
                      </div>
                    )}
                  </div>
                  <div className="p-8">
                    <h3 
                      className="text-2xl font-black text-slate-800 mb-4 cursor-pointer"
                      onClick={() => {
                        if (game.officialWebsite) {
                          window.open(game.officialWebsite, '_blank');
                        } else {
                          updateUrl('HOME', game.id);
                        }
                      }}
                    >
                      {game.name}
                    </h3>
                    <div className="grid grid-cols-2 gap-3">
                      {getAllSectionTypes().map((sectionType) => {
                        const section = game.sections.find(s => s.type === sectionType);
                        const hasContent = section && section.items.length > 0;
                        return (
                          <button
                            key={sectionType}
                            onClick={(e) => {
                              e.stopPropagation();
                              if (hasContent) {
                                updateUrl('HOME', game.id, sectionType);
                              } else {
                                updateUrl('HOME', game.id);
                              }
                            }}
                            className={`w-full py-2.5 rounded-xl text-sm font-bold transition-all ${
                              hasContent 
                                ? 'bg-gradient-to-r from-pink-500 to-red-500 text-white'
                                : 'bg-gradient-to-r from-pink-200 to-red-200 text-pink-300 cursor-not-allowed'
                            }`}
                            disabled={!hasContent}
                          >
                            {sectionType}
                          </button>
                        );
                      })}
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </section>
      </div>
    );
  };

  return (
    <Layout 
      activeCategory={activeCategory} 
      setActiveCategory={(cat) => { 
        window.scrollTo({ top: 0, behavior: 'smooth' });
        updateUrl(cat);
      }}
      searchQuery={searchQuery}
      onSearch={(q) => {
        setSearchQuery(q);
        updateUrl('SEARCH', undefined, undefined, q);
      }}
      gameName={selectedGame ? selectedGame.name : undefined}
      onBackToHome={() => {}}
      isAdminLoggedIn={isAdminLoggedIn}
      selectedGame={selectedGame}
      onEditGame={(game) => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        updateUrl('ADMIN');
        setTimeout(() => {
          const adminPanel = document.querySelector(`[data-game-id="${game.id}"]`);
          if (adminPanel) {
            adminPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 300);
      }}
    >
      {renderContent()}
    </Layout>
  );
};

const App: React.FC = () => {
  return <AppContent />;
};

export default App;
